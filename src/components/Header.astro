---
import type { Translation } from "../i18n/types";
import { languages, defaultLang, langCodes } from "../i18n/index";

interface Props {
  t: Translation;
}

const { t } = Astro.props;
const langPrefix = t.lang === defaultLang ? "" : `/${t.lang}`;
const navLinks = [
  { name: t.nav.exposition, href: `${langPrefix}/exposition/` },
  { name: t.nav.education, href: `${langPrefix}/education/` },
  { name: t.nav.prices, href: `${langPrefix}/prices/` },
  { name: t.nav.visit, href: `${langPrefix}/contacts/` },
];
const langEntries = Object.entries(languages);

// Derive the page slug from the current URL for lang-switching links
const pathParts = Astro.url.pathname.replace(/^\//, "").split("/");
const pagePath = pathParts[0] && langCodes.includes(pathParts[0])
  ? pathParts.slice(1).join("/")
  : pathParts.join("/");
---

<header
  id="site-header"
  class="fixed w-full z-50 transition-all duration-300 bg-transparent py-4 sm:py-6"
>
  <div class="max-w-7xl mx-auto px-6 flex justify-between items-center">
    <!-- Logo -->
    <a href={t.lang === defaultLang ? "/" : `/${t.lang}/`} class="flex items-center gap-2.5 sm:gap-3 group">
      <img
        src="/logo.svg"
        alt="Telephony Museum"
        width="48"
        height="48"
        class="w-11 h-11 sm:w-12 sm:h-12 group-hover:rotate-12 transition-transform duration-300"
      />
      <div>
        <span class="text-lg sm:text-xl font-black tracking-tight sm:tracking-tighter uppercase block leading-none">Telephony</span>
        <span class="text-[10px] uppercase tracking-[0.2em] text-accent font-semibold">Museum</span>
      </div>
    </a>

    <!-- Desktop Nav -->
    <nav class="hidden lg:flex items-center gap-6">
      {navLinks.map((link) => (
        <a href={link.href} class="text-sm font-medium tracking-wide hover:text-accent transition-colors">
          {link.name}
        </a>
      ))}

      <!-- Language Switcher -->
      <div class="relative group">
        <button class="flex items-center gap-1.5 text-sm font-medium px-3 py-1.5 rounded-lg border border-white/10 hover:border-accent/50 transition-colors cursor-pointer">
          <span class="text-base leading-none">{t.flag}</span>
          <span class="uppercase text-xs tracking-wider">{t.lang}</span>
          <svg class="w-3 h-3 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <div class="absolute right-0 top-full mt-2 bg-dark-card border border-white/10 rounded-xl shadow-2xl py-2 min-w-[160px] opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
          {langEntries.map(([code, lang]) => {
            const prefix = code === defaultLang ? "" : `/${code}`;
            const suffix = pagePath ? `/${pagePath}` : "/";
            return (
              <a
                href={`${prefix}${suffix}`}
                class:list={[
                  "flex items-center gap-3 px-4 py-2 text-sm hover:bg-white/5 transition-colors",
                  code === t.lang ? "text-accent" : "text-gray-400",
                ]}
              >
                <span class="text-base">{lang.flag}</span>
                <span>{lang.langName}</span>
              </a>
            );
          })}
        </div>
      </div>

      <a href={`${langPrefix}/parama/`} class="bg-accent text-dark-bg px-6 py-2.5 rounded-full text-sm font-bold hover:bg-accent-light transition-all hover:scale-105">
        {t.nav.supportUs}
      </a>
    </nav>

    <!-- Mobile Menu Button -->
    <button id="mobile-menu-btn" class="lg:hidden text-white p-3" aria-label="Open menu">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
      </svg>
    </button>
  </div>
</header>

<!-- Mobile Menu Overlay -->
<div id="mobile-menu" class="fixed inset-0 z-[60] bg-dark-bg flex flex-col items-center justify-center gap-6 sm:gap-8 translate-x-full transition-transform duration-300 lg:hidden overflow-y-auto py-20">
  <button id="mobile-menu-close" class="absolute top-6 right-6 text-white p-2" aria-label="Close menu">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
    </svg>
  </button>
  {navLinks.map((link) => (
    <a href={link.href} class="mobile-nav-link text-xl sm:text-2xl font-bold hover:text-accent transition-colors">
      {link.name}
    </a>
  ))}
  <!-- Mobile Language Switcher -->
  <div class="flex flex-wrap justify-center gap-1.5 sm:gap-2 pt-4 px-4">
    {langEntries.map(([code, lang]) => {
      const prefix = code === defaultLang ? "" : `/${code}`;
      const suffix = pagePath ? `/${pagePath}` : "/";
      return (
        <a
          href={`${prefix}${suffix}`}
          class:list={[
            "px-2.5 py-1 sm:px-3 sm:py-1.5 rounded-lg text-xs sm:text-sm border transition-colors",
            code === t.lang
              ? "border-accent text-accent bg-accent/10"
              : "border-white/10 text-gray-400 hover:border-accent/50",
          ]}
        >
          {lang.flag} {lang.langName}
        </a>
      );
    })}
  </div>
  <a href={`${langPrefix}/parama/`} class="mobile-nav-link bg-accent text-dark-bg px-8 sm:px-10 py-3 sm:py-4 rounded-full text-base sm:text-lg font-bold">
    {t.nav.supportUs}
  </a>
</div>

<script>
  const header = document.getElementById("site-header");
  const menuBtn = document.getElementById("mobile-menu-btn");
  const mobileMenu = document.getElementById("mobile-menu");
  const closeBtn = document.getElementById("mobile-menu-close");
  const mobileLinks = document.querySelectorAll(".mobile-nav-link");

  function toggleMenu() {
    mobileMenu?.classList.toggle("translate-x-full");
    document.body.classList.toggle("overflow-hidden");
  }

  menuBtn?.addEventListener("click", toggleMenu);
  closeBtn?.addEventListener("click", toggleMenu);
  mobileLinks.forEach((link) => link.addEventListener("click", toggleMenu));

  window.addEventListener("scroll", () => {
    if (!header) return;
    if (window.scrollY > 20) {
      header.classList.add("bg-dark-bg/95", "backdrop-blur-md", "border-b", "border-white/5", "shadow-2xl");
      header.classList.remove("bg-transparent", "py-6");
      header.classList.add("py-4");
    } else {
      header.classList.remove("bg-dark-bg/95", "backdrop-blur-md", "border-b", "border-white/5", "shadow-2xl", "py-4");
      header.classList.add("bg-transparent", "py-6");
    }
  });
</script>
